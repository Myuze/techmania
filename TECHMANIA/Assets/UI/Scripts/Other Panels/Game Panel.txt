function InitializeGamePanel(tm)
    local panel = tm.root.Q("game-panel")

    panel.RegisterCallback(eventType.KeyDown, function(element, event)
        if (event.keyCode == unity.enum.keyCode.Escape) then
            if (tm.game.state == tm.enum.gameState.Paused) then
                UnpauseGame(tm, panel)
            elseif (tm.game.state == tm.enum.gameState.Ongoing) then
                PauseGame(tm, panel)
            end
        end
        if (event.keyCode == unity.enum.keyCode.Space or
            event.keyCode == unity.enum.keyCode.Backspace) then
        end
    end)

    panel.Q("pause-button").RegisterCallback(eventType.Click, function()
        PauseGame(tm, panel)
    end)

    panel.Q("fever-bar-bg").RegisterCallback(eventType.PointerDown, function()
    end)

    tm.gameSetup.bgContainer = panel.Q("bg-layer")
    tm.gameSetup.gameContainer = panel.Q("game-layer")
    tm.gameSetup.vfxComboContainer = nil  -- Unused

    tm.gameSetup.onLoadProgress = function(progress)
        local percent = progress.filesLoaded * 100 / progress.totalFiles
        SetProgressBar(panel.Q("loading-progress"), percent)
    end

    tm.gameSetup.onLoadError = function(status)
        tm.game.Conclude()
        Alert(status.errorMessage, nil, function()
            GamePanelToSelectTrackPanel(tm)
        end)
    end

    tm.gameSetup.onLoadComplete = function()
        GamePanelBeginGame(tm, panel)
    end

    tm.gameSetup.onUpdate = function()
    end

    tm.gameSetup.onNoteResolved = function()
    end

    tm.gameSetup.onAllNotesResolved = function()
    end

    tm.gameSetup.onFeverUpdate = function(fever)
    end

    tm.gameSetup.onFeverEnd = function(feverBonus)
    end
end

function InitializePauseMenu(tm)
    local panel = tm.root.Q("game-panel")
    local bg = panel.Q("pause-menu-bg")
    local menu = bg.Q("pause-menu")

    menu.RegisterCallback(eventType.Click, function(element, event)
        -- Prevents bg from receiving this event on the bubble up phase
        event.StopPropagation()
    end)

    function OnCancel()
        UnpauseGame(tm, panel)
    end
    menu.Q("resume-button").RegisterCallback(eventType.Click, OnCancel)
    bg.RegisterCallback(eventType.Click, OnCancel)
    bg.RegisterCallback(eventType.Click, function(_, _)
        tm.audio.Play(util.io.LoadAudioFromTheme("Assets/UI/SFX/Back.wav"), tm.enum.audioChannel.SFX)
    end)

    menu.Q("restart-button").RegisterCallback(eventType.Click, function()
        tm.game.Conclude()
        GamePanelStartLoading(tm)
    end)

    menu.Q("select-track-button").RegisterCallback(eventType.Click, function()
        tm.game.Conclude()
        GamePanelToSelectTrackPanel(tm)
    end)

    InitializeBgBrightnessSlider(tm, menu.Q("bg-brightness-wrap"))
    InitializeVolumeSliders(menu)
end

function ShowPauseMenu(menu)
    ShowBgBrightnessSlider(menu.Q("bg-brightness-wrap"))
    ShowVolumeSliders(menu)
end

function GamePanelStartLoading(tm)
    local panel = tm.root.Q("game-panel")

    panel.Q("top-bar").visible = false  -- Cannot turn off display as it influences #remaining-space
    panel.Q("top-bar").Q("pause-button").display = true
    panel.Q("top-bar").Q("back-button").display = false
    panel.Q("top-bar").Q("regular-top-bar").display = tm.options.modifiers.mode != tm.enum.mode.Practice
    panel.Q("top-bar").Q("practice-top-bar").display = tm.options.modifiers.mode == tm.enum.mode.Practice
    panel.Q("middle-fever-bar-bg").display = false
    panel.Q("loading-bar-wrap").display = themeOptions.Get("showLoadingBar") == "True"
    panel.InsertChild(0, panel.Q("bg-layer"))
    panel.Q("pause-menu-bg").display = false

    -- TODO: respond to showFps option
    -- TODO: respond to showJudgementTally option
    -- TODO: respond to showLaneDividers option
    -- TODO: respond to beatMarkers option

    tm.options.TemporarilyDisableVSync()
    tm.game.BeginLoading()
end

function GamePanelBeginGame(tm, panel)
    if (themeOptions.Get("backgroundScalingMode") == "FillGameArea") then
        panel.Q("remaining-space").InsertChild(0, panel.Q("bg-layer"))
    end

    panel.Q("top-bar").visible = true
    panel.Q("middle-fever-bar-bg").display = true
    panel.Q("loading-bar-wrap").display = false

    tm.options.RestoreVSync()
    tm.game.Begin()

    -- Give game panel focus so it can receive keyboard events
    panel.Focus()
end

function PauseGame(tm, panel)
    if (tm.game.state != tm.enum.gameState.Ongoing) then return end
    local bg = panel.Q("pause-menu-bg")
    local menu = bg.Q("pause-menu")
    tm.audio.Play(util.io.LoadAudioFromTheme("Assets/UI/SFX/Pause.wav"), tm.enum.audioChannel.SFX)
    tm.game.Pause()
    FadeInDialog(bg, menu)
    ShowPauseMenu(menu)
end

function UnpauseGame(tm, panel)
    local bg = panel.Q("pause-menu-bg")
    local menu = bg.Q("pause-menu")
    FadeOutDialog(bg, menu, function()
        -- Only unpause after the menu has fully faded out.
        tm.game.Unpause()
    end)
end

InitializeGamePanel(tm)
InitializePauseMenu(tm)