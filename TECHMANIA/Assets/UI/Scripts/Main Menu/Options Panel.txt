themeOptions = nil

-- key: enum, value: display string
fullScreenDisplayString = {}
beatMarkersDisplayString = {}
bgScalingDisplayString = {}
rulesetDisplayString = {}

function InitializeThemeOptions(tm)
    themeOptions = tm.options.GetThemeOptions()

    function InitializeOneOption(key, defaultValue)
        if (not themeOptions.Has(key)) then
            themeOptions.Set(key, defaultValue)
        end
    end

    InitializeOneOption("showLoadingBar", "True")
    InitializeOneOption("showFps", "False")
    InitializeOneOption("showJudgementTally", "False")
    InitializeOneOption("showLaneDividers", "False")
    -- Hidden/ShowBeatMarkers/ShowHalfBeatMarker
    InitializeOneOption("beatMarkers", "Hidden")
    -- FillEntireScreen/FillGameArea
    InitializeOneOption("backgroundScalingMode", "FillEntireScreen")
    InitializeOneOption("pauseWhenGameLosesFocus", "True")
end

function UpdateVolumeDisplay(panel)
    function UpdateOneVolumeDisplay(container)
        local slider = container.Q("slider")
        local display = container.Q("value-display")
        display.text = tostring(slider.value)
    end
    UpdateOneVolumeDisplay(panel.Q("master"))
    UpdateOneVolumeDisplay(panel.Q("music"))
    UpdateOneVolumeDisplay(panel.Q("keysounds"))
    UpdateOneVolumeDisplay(panel.Q("sound-effects"))
end

function UpdateCustomDataLocationDisplay(tm, panel)
    local tracksContainer = panel.Q("tracks-folder-location")
    local skinsContainer = panel.Q("skins-folder-location")
    if (tm.options.customDataLocation) then
        if (tm.options.tracksFolderLocation == nil or
            tm.options.tracksFolderLocation == "") then
            tm.options.tracksFolderLocation = tm.paths.GetTrackRootFolder()
        end
        if (tm.options.skinsFolderLocation == nil or
            tm.options.skinsFolderLocation == "") then
            tm.options.skinsFolderLocation = tm.paths.GetSkinFolder()
        end
        tracksContainer.display = true
        tracksContainer.Q("location-display").text = tm.paths.EscapeBackslash(tm.options.tracksFolderLocation)
        skinsContainer.display = true
        skinsContainer.Q("location-display").text = tm.paths.EscapeBackslash(tm.options.skinsFolderLocation)
    else
        tracksContainer.display = false
        skinsContainer.display = false
    end
end

function ShowOptionsPanel(tm)
    local panel = tm.root.Q("options-panel")

    local currentResolution = resolution.__new()
    currentResolution.width = tm.options.width
    currentResolution.height = tm.options.height
    currentResolution.refreshRate = tm.options.refreshRate
    local resolutionDropdown = panel.Q("resolution").Q("dropdown")
    resolutionDropdown.SetValueWithoutNotify(currentResolution.ToString())

    local fullScreenDropdown = panel.Q("fullscreen-mode").Q("dropdown")
    fullScreenDropdown.SetValueWithoutNotify(fullScreenDisplayString[tm.options.fullScreenMode])

    local vSyncToggle = panel.Q("vsync").Q("track")
    SetToggleIsOn(vSyncToggle, tm.options.vSync)

    local masterSlider = panel.Q("master").Q("slider")
    local musicSlider = panel.Q("music").Q("slider")
    local keysoundsSlider = panel.Q("keysounds").Q("slider")
    local sfxSlider = panel.Q("sound-effects").Q("slider")
    SetSliderValueWithoutNotify(masterSlider, tm.options.masterVolumePercent)
    SetSliderValueWithoutNotify(musicSlider, tm.options.musicVolumePercent)
    SetSliderValueWithoutNotify(keysoundsSlider, tm.options.keysoundVolumePercent)
    SetSliderValueWithoutNotify(sfxSlider, tm.options.sfxVolumePercent)
    UpdateVolumeDisplay(panel)

    local audioBufferDropdown = panel.Q("audio-buffer-size").Q("dropdown")
    audioBufferDropdown.SetValueWithoutNotify(tostring(tm.options.audioBufferSize))

    local languageDropdown = panel.Q("language").Q("dropdown")
    local locale = tm.l10n.GetAllLocales()[tm.options.locale]
    languageDropdown.SetValueWithoutNotify(locale.languageName)

    function ShowThemeOptionToggle(containerName, key)
        local toggle = panel.Q(containerName).Q("track")
        SetToggleIsOn(toggle, bool.Parse(themeOptions.Get(key)))
    end
    ShowThemeOptionToggle("show-loading-bar", "showLoadingBar")
    ShowThemeOptionToggle("show-fps", "showFps")
    ShowThemeOptionToggle("show-judgement-tally", "showJudgementTally")
    ShowThemeOptionToggle("show-lane-dividers", "showLaneDividers")

    local beatMarkersDropdown = panel.Q("beat-markers").Q("dropdown")
    beatMarkersDropdown.SetValueWithoutNotify(beatMarkersDisplayString[themeOptions.Get("beatMarkers")])
    local bgScalingDropdown = panel.Q("background-scaling").Q("dropdown")
    bgScalingDropdown.SetValueWithoutNotify(bgScalingDisplayString[themeOptions.Get("backgroundScalingMode")])

    local rulesetDropdown = panel.Q("ruleset").Q("dropdown")
    rulesetDropdown.SetValueWithoutNotify(rulesetDisplayString[tm.options.ruleset])

    local customLocationToggle = panel.Q("custom-data-location").Q("track")
    SetToggleIsOn(customLocationToggle, tm.options.customDataLocation)
    UpdateCustomDataLocationDisplay(tm, panel)

    local offsetLatencyDisplay = panel.Q("offset-latency").Q("value-display")
    offsetLatencyDisplay.text =
        tm.options.touchOffsetMs .. "/" ..
        tm.options.touchLatencyMs .. "/" ..
        tm.options.keyboardMouseOffsetMs .. "/" ..
        tm.options.keyboardMouseLatencyMs .. " ms"

    ShowThemeOptionToggle("pause-when-lose-focus", "pauseWhenGameLosesFocus")
end

function InitializeOptionsPanel(tm)
    function InitializeLocalizedDropdowns(panel)
        function InitializeOneLocalizedDropdown(containerName, stringTable)
            local dropdown = panel.Q(containerName).Q("dropdown")
            local choices = {}
            for enum, display in pairs(stringTable) do
                table.insert(choices, display)
            end
            dropdown.choices = choices
        end

        fullScreenDisplayString = {
            ExclusiveFullScreen = tm.l10n.GetString("fullscreen_mode_exclusive_fullscreen"),
            FullScreenWindow = tm.l10n.GetString("fullscreen_mode_fullscreen_window"),
            MaximizedWindow = tm.l10n.GetString("fullscreen_mode_maximized_window"),
            Windowed = tm.l10n.GetString("fullscreen_mode_windowed")
        }
        InitializeOneLocalizedDropdown("fullscreen-mode", fullScreenDisplayString)
        
        beatMarkersDisplayString = {
            Hidden = tm.l10n.GetString("beat_markers_hidden"),
            ShowBeatMarkers = tm.l10n.GetString("beat_markers_show_beat_markers"),
            ShowHalfBeatMarkers = tm.l10n.GetString("beat_markers_show_half_beat_markers")
        }
        InitializeOneLocalizedDropdown("beat-markers", beatMarkersDisplayString)

        bgScalingDisplayString = {
            FillEntireScreen = tm.l10n.GetString("bg_scaling_fill_entire_screen"),
            FillGameArea = tm.l10n.GetString("bg_scaling_fill_game_area")
        }
        InitializeOneLocalizedDropdown("background-scaling", bgScalingDisplayString)

        rulesetDisplayString = {
            Standard = tm.l10n.GetString("ruleset_standard"),
            Legacy = tm.l10n.GetString("ruleset_legacy"),
            Custom = tm.l10n.GetString("ruleset_custom")
        }
        InitializeOneLocalizedDropdown("ruleset", rulesetDisplayString)
    end

    local panel = tm.root.Q("options-panel")
    InitializeLocalizedDropdowns(panel)
    table.insert(callbacksOnLocaleChange, function()
        InitializeLocalizedDropdowns(panel)
    end)
    panel.display = false

    local resolutionDropdown = panel.Q("resolution").Q("dropdown")
    local resolutionChoices = {}
    for i, resolution in ipairs(screen.resolutions) do
        table.insert(resolutionChoices, resolution.ToString())
    end
    resolutionDropdown.choices = resolutionChoices
    resolutionDropdown.RegisterCallback("ChangeString", function(element, event)
        for _, resolution in ipairs(screen.resolutions) do
            if (resolution.ToString() == event.newValue) then
                tm.options.width = resolution.width
                tm.options.height = resolution.height
                tm.options.refreshRate = resolution.refreshRate
                break
            end
        end
        tm.options.ApplyGraphicSettings()
    end)

    local fullScreenDropdown = panel.Q("fullscreen-mode").Q("dropdown")
    fullScreenDropdown.RegisterCallback("ChangeString", function(element, event)
        tm.options.fullScreenMode = KeyFromValue(fullScreenDisplayString, event.newValue)
        tm.options.ApplyGraphicSettings()
    end)

    local vSyncToggle = panel.Q("vsync").Q("track")
    vSyncToggle.RegisterCallback("Click", function()
        tm.options.vSync = not tm.options.vSync
        tm.options.ApplyGraphicSettings()
    end)

    local masterSlider = panel.Q("master").Q("slider")
    local musicSlider = panel.Q("music").Q("slider")
    local keysoundsSlider = panel.Q("keysounds").Q("slider")
    local sfxSlider = panel.Q("sound-effects").Q("slider")
    masterSlider.lowValue = 0
    masterSlider.highValue = 100
    masterSlider.RegisterCallback("ChangeInt", function(element, event)
        tm.options.masterVolumePercent = event.newValue
        tm.options.ApplyVolumeSettings()
        UpdateVolumeDisplay(panel)
    end)
    musicSlider.lowValue = 0
    musicSlider.highValue = 100
    musicSlider.RegisterCallback("ChangeInt", function(element, event)
        tm.options.musicVolumePercent = event.newValue
        tm.options.ApplyVolumeSettings()
        UpdateVolumeDisplay(panel)
    end)
    keysoundsSlider.lowValue = 0
    keysoundsSlider.highValue = 100
    keysoundsSlider.RegisterCallback("ChangeInt", function(element, event)
        tm.options.keysoundVolumePercent = event.newValue
        tm.options.ApplyVolumeSettings()
        UpdateVolumeDisplay(panel)
    end)
    sfxSlider.lowValue = 0
    sfxSlider.highValue = 100
    sfxSlider.RegisterCallback("ChangeInt", function(element, event)
        tm.options.sfxVolumePercent = event.newValue
        tm.options.ApplyVolumeSettings()
        UpdateVolumeDisplay(panel)
    end)

    local audioBufferDropdown = panel.Q("audio-buffer-size").Q("dropdown")
    audioBufferDropdown.choices = {"128", "256", "512", "1024"}
    audioBufferDropdown.RegisterCallback("ChangeString", function(element, event)
        tm.options.audioBufferSize = int.Parse(event.newValue)
        tm.options.ApplyAudioBufferSize()
    end)

    local languageDropdown = panel.Q("language").Q("dropdown")
    local languageChoices = {}
    local languageChoiceToLocaleName = {}
        for localeName, locale in pairs(tm.l10n.GetAllLocales()) do
            table.insert(languageChoices, locale.languageName)
            languageChoiceToLocaleName[locale.languageName] = localeName
        end
    languageDropdown.choices = languageChoices
    languageDropdown.RegisterCallback("ChangeString", function(element, event)
        tm.options.locale = languageChoiceToLocaleName[event.newValue]
        tm.l10n.ApplyLocale()
        for _, callback in ipairs(callbacksOnLocaleChange) do
            callback()
        end
        ShowOptionsPanel(tm)
    end)

    local skinsButton = panel.Q("skins").Q("button")
    skinsButton.RegisterCallback("Click", function()
    end)

    function InitializeThemeOptionToggle(containerName, key)
        local toggle = panel.Q(containerName).Q("track")
        toggle.RegisterCallback("Click", function()
            local oldValue = themeOptions.Get(key)
            local newValue = ""
            if (oldValue == "True") then
                newValue = "False"
            else
                newValue = "True"
            end
            themeOptions.Set(key, newValue)
        end)
    end
    InitializeThemeOptionToggle("show-loading-bar", "showLoadingBar")
    InitializeThemeOptionToggle("show-fps", "showFps")
    InitializeThemeOptionToggle("show-judgement-tally", "showJudgementTally")
    InitializeThemeOptionToggle("show-lane-dividers", "showLaneDividers")

    function InitializeThemeOptionDropdown(containerName, key, stringTable)
        local dropdown = panel.Q(containerName).Q("dropdown")
        dropdown.RegisterCallback("ChangeString", function(element, event)
            enum = KeyFromValue(stringTable, event.newValue)
            themeOptions.Set(key, enum)
        end)
    end
    InitializeThemeOptionDropdown("beat-markers", "beatMarkers", beatMarkersDisplayString)
    InitializeThemeOptionDropdown("background-scaling", "backgroundScalingMode", bgScalingDisplayString)

    local rulesetDropdown = panel.Q("ruleset").Q("dropdown")
    rulesetDropdown.RegisterCallback("ChangeString", function(element, event)
        tm.options.ruleset = KeyFromValue(rulesetDisplayString, event.newValue)
        if (tm.options.ruleset == "Custom") then
            local status = tm.ruleset.LoadCustomRuleset()
            if (not status.ok) then
                local errorFormat = tm.l10n.GetString("custom_ruleset_not_found_error_format")
                local path = tm.paths.EscapeBackslash(tm.paths.GetRulesetFilePath())
                local error = netString.Format(errorFormat, path)
                Alert(error)
                tm.options.ruleset = "Standard"
                rulesetDropdown.SetValueWithoutNotify(rulesetDisplayString["Standard"])
            end
        end
    end)

    local customLocationToggle = panel.Q("custom-data-location").Q("track")
    customLocationToggle.RegisterCallback("Click", function()
        tm.options.customDataLocation = not tm.options.customDataLocation
        trackListNeedsRefresh = true
        UpdateCustomDataLocationDisplay(tm, panel)
    end)

    local tracksFolderButton = panel.Q("tracks-folder-location").Q("button")
    tracksFolderButton.RegisterCallback("Click", function()
        local newFolder = tm.OpenSelectFolderDialog("", tm.options.tracksFolderLocation)
        if (newFolder != nil) then
            tm.options.tracksFolderLocation = newFolder;
            tm.paths.ApplyCustomDataLocation()
            trackListNeedsRefresh = true
            UpdateCustomDataLocationDisplay(tm, panel)
        end
    end)
    local skinsFolderButton = panel.Q("skins-folder-location").Q("button")
    skinsFolderButton.RegisterCallback("Click", function()
        local newFolder = tm.OpenSelectFolderDialog("", tm.options.skinsFolderLocation)
        if (newFolder != nil) then
            tm.options.skinsFolderLocation = newFolder;
            tm.paths.ApplyCustomDataLocation()
            UpdateCustomDataLocationDisplay(tm, panel)
        end
    end)

    InitializeThemeOptionToggle("pause-when-lose-focus", "pauseWhenGameLosesFocus")
end

InitializeThemeOptions(tm)
InitializeOptionsPanel(tm)