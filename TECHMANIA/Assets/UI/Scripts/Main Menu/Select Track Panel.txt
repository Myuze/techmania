selectTrackPanelLocation = ""

function ShowTracksAtCurrentLocation(tm)
    local panel = tm.root.Q("select-track-panel")

    panel.Q("location-display").text = tm.paths.EscapeBackslash(selectTrackPanelLocation)
    panel.Q("up-button").SetEnabled(selectTrackPanelLocation != tm.paths.GetTrackRootFolder())

    local subfolderContainer = panel.Q("subfolder-container")
    for _, child in ipairs(subfolderContainer.Children()) do
        child.RemoveFromHierarchy()
    end

    local trackContainer = panel.Q("track-container")
    for _, child in ipairs(trackContainer.Children()) do
        child.RemoveFromHierarchy()
    end

    function HandleEyecatch(card, status, texture)
        if (status.Ok()) then
            card.Q("eyecatch").backgroundImage = texture
            card.Q("default-eyecatch").visible = false
        else
            card.Q("default-eyecatch").visible = true
        end
    end

    local subfolders = tm.resources.GetSubfolders(selectTrackPanelLocation)
    for _, subfolder in ipairs(subfolders) do
        local card = subfolderContainer.InstantiateTemplate("Assets/UI/Templates/Subfolder Card.uxml").Q("subfolder-card")
        if (subfolder.eyecatchFullPath != nil) then
            tm.io.LoadTexture(subfolder.eyecatchFullPath, function(status, texture)
                HandleEyecatch(card, status, texture)
            end)
        end
        SetUpButtonSounds(tm, card)
        card.Q("name").text = tm.paths.EscapeBackslash(subfolder.name)
        SetUpScrollingText(tm, card.Q("name-container"))
        card.RegisterCallback("Click", function(_, _, subfolder)
            selectTrackPanelLocation = subfolder.fullPath
            ShowTracksAtCurrentLocation(tm)
        end, subfolder)
    end

    local tracksInFolder = tm.resources.GetTracksInFolder(selectTrackPanelLocation)
    for _, trackInFolder in ipairs(tracksInFolder) do
        local card = trackContainer.InstantiateTemplate("Assets/UI/Templates/Track Card.uxml").Q("track-card")
        card.Q("default-eyecatch").text = tm.l10n.GetString("eyecatch_no_image_text")
        local eyecatchPath = tm.paths.Combine(trackInFolder.folder, trackInFolder.minimizedTrack.trackMetadata.eyecatchImage)
        tm.io.LoadTexture(eyecatchPath, function(status, texture)
            HandleEyecatch(card, status, texture)
        end)
        SetUpButtonSounds(tm, card)
        card.Q("name").text = tm.paths.EscapeBackslash(trackInFolder.minimizedTrack.trackMetadata.title)
        card.Q("artist").text = tm.paths.EscapeBackslash(trackInFolder.minimizedTrack.trackMetadata.artist)
        SetUpScrollingText(tm, card.Q("name-container"))
        SetUpScrollingText(tm, card.Q("artist-container"))
        card.RegisterCallback("Click", function(_, _, trackInFolder)
            print(trackInFolder.minimizedTrack.trackMetadata.title)
        end, trackInFolder)
    end
end

function ShowSelectTrackPanel(tm)
    ShowTracksAtCurrentLocation(tm)
end

function InitializeSelectTrackPanel(tm)
    selectTrackPanelLocation = tm.paths.GetTrackRootFolder()

    local panel = tm.root.Q("select-track-panel")
    panel.Q("up-button").RegisterCallback("Click", function()
        selectTrackPanelLocation = tm.paths.GoUpFrom(selectTrackPanelLocation)
        ShowTracksAtCurrentLocation(tm)
    end)

    panel.Q("open-button").RegisterCallback("Click", function()
        tm.OpenURL(selectTrackPanelLocation)
    end)
end

InitializeSelectTrackPanel(tm)