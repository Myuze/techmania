selectedTrackFolder = ""
selectedFullTrack = nil
allPatternRadioButtons = {}

-- pattern may be nil.
function ShowPatternDetails(panel, pattern)
    if (pattern == nil) then
        panel.Q("bpm").Q("content").text = ""
        panel.Q("length").Q("content").text = ""
        panel.Q("notes").Q("content").text = ""
        panel.Q("author").Q("content").text = ""
        panel.Q("record").Q("content").text = ""
        return
    end

    -- TODO: don't count hidden notes
    panel.Q("notes").Q("content").text = pattern.notes.Count
    panel.Q("author").Q("content").text = pattern.patternMetadata.author
    local record = tm.records.GetRecord(pattern)
    if (record == nil) then
        panel.Q("record").Q("content").text = "---"
    else
        panel.Q("record").Q("content").text = record.GetScore()
        -- TODO: rank
        -- TODO: medal
    end
end

function ShowSelectPatternPanel(tm)
    local panel = tm.root.Q("select-pattern-panel")
    local track = selectedFullTrack

    local eyecatchPath = tm.paths.Combine(selectedTrackFolder, track.trackMetadata.eyecatchImage)
    LoadAndShowEyecatch(tm, eyecatchPath, panel.Q("eyecatch"))
    panel.Q("metadata-wrap").Q("genre").text = tm.paths.EscapeBackslash(track.trackMetadata.genre)
    panel.Q("metadata-wrap").Q("title").text = tm.paths.EscapeBackslash(track.trackMetadata.title)
    panel.Q("metadata-wrap").Q("artist").text = tm.paths.EscapeBackslash(track.trackMetadata.artist)

    panel.Q("pattern-list").Q("no-pattern-text").display = (#track.patterns == 0)
    local patternListContainer = panel.Q("pattern-list").Q("unity-content-container")
    for _, child in ipairs(patternListContainer.Children()) do
        child.RemoveFromHierarchy()
    end
    allPatternRadioButtons = {}
    for _, pattern in ipairs(track.patterns) do
        local radioButton = patternListContainer.InstantiateTemplate("Assets/UI/Templates/Pattern Radio Button.uxml").Q("radio-button")
        table.insert(allPatternRadioButtons, radioButton)
        SetUpButtonSounds(tm, radioButton)

        local metadata = pattern.patternMetadata

        radioButton.Q("2l-icon").display = metadata.playableLanes == 2
        radioButton.Q("3l-icon").display = metadata.playableLanes == 3
        radioButton.Q("4l-icon").display = metadata.playableLanes == 4
        radioButton.Q("touch-icon").display = metadata.controlSchemeString == "Touch"
        radioButton.Q("keys-icon").display = metadata.controlSchemeString == "Keys"
        radioButton.Q("km-icon").display = metadata.controlSchemeString == "KM"
        radioButton.Q("level").text = metadata.level
        radioButton.Q("pattern-name").text = metadata.patternName
        SetUpScrollingText(tm, radioButton.Q("pattern-name-container"))

        local record = tm.records.GetRecord(pattern)
        local medal = ""
        if (record != nil) then
            medal = record.GetMedal()
        end
        if (medal == "AbsolutePerfect" or
            medal == "PerfectPlay") then
            radioButton.Q("perfect-play-icon").display = true
            radioButton.Q("all-combo-icon").display = false
        elseif (medal == "AllCombo") then
            radioButton.Q("perfect-play-icon").display = false
            radioButton.Q("all-combo-icon").display = true
        else
            radioButton.Q("perfect-play-icon").display = false
            radioButton.Q("all-combo-icon").display = false
        end

        radioButton.RegisterCallback("Click", function(_, _, pattern)
            SetRadioButton(radioButton, allPatternRadioButtons)
            ShowPatternDetails(panel, pattern)
            panel.Q("play-button").SetEnabled(true)
        end, pattern)
    end
    SetRadioButton(nil, allPatternRadioButtons)
    ShowPatternDetails(panel, nil)
    panel.Q("play-button").SetEnabled(false)
end

function InitializeSelectPatternPanel(tm)

end

InitializeSelectPatternPanel(tm)